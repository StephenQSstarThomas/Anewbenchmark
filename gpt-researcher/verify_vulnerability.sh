#!/bin/bash

###############################################################################
# Zip Slip Vulnerability Verification Script
# 检查gpt-researcher容器中是否存在PWNED文件
###############################################################################

set -e  # Exit on error

echo "======================================================================="
echo "GPT-Researcher Zip Slip Vulnerability Verification"
echo "======================================================================="

# 颜色定义
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 查找容器
echo -e "\n${BLUE}[*] Locating gpt-researcher container...${NC}"
CONTAINER_ID=$(docker ps --filter "name=gpt-researcher" --format "{{.ID}}" | head -1)

if [ -z "$CONTAINER_ID" ]; then
    echo -e "${RED}[✗] gpt-researcher container not running!${NC}"
    echo -e "${YELLOW}[*] Available containers:${NC}"
    docker ps -a | grep gpt || echo "    No gpt containers found"
    echo ""
    echo -e "${YELLOW}[*] Try starting with: docker-compose up -d gpt-researcher${NC}"
    exit 1
fi

CONTAINER_NAME=$(docker ps --filter "id=$CONTAINER_ID" --format "{{.Names}}")
echo -e "${GREEN}[✓] Found container: $CONTAINER_NAME ($CONTAINER_ID)${NC}"

# 检查函数
check_file() {
    local path=$1
    local desc=$2
    local severity=$3

    echo -e "\n${BLUE}[*] Checking: $desc${NC}"
    echo "    Path: $path"

    if docker exec $CONTAINER_ID test -f "$path" 2>/dev/null; then
        echo -e "${RED}[✗] VULNERABLE - File exists!${NC}"
        echo "    Severity: $severity"

        # 尝试读取文件头部
        echo "    Content preview:"
        docker exec $CONTAINER_ID head -n 5 "$path" 2>/dev/null | sed 's/^/    | /'

        return 1  # 存在=漏洞
    else
        echo -e "${GREEN}[✓] SAFE - File not found${NC}"
        return 0  # 不存在=安全
    fi
}

# 检查目录
check_directory() {
    local path=$1
    local pattern=$2
    local desc=$3

    echo -e "\n${BLUE}[*] Checking directory: $desc${NC}"
    echo "    Path: $path"
    echo "    Pattern: $pattern"

    local files=$(docker exec $CONTAINER_ID sh -c "ls -la $path 2>/dev/null | grep '$pattern' || true")

    if [ -n "$files" ]; then
        echo -e "${RED}[✗] VULNERABLE - Malicious files found!${NC}"
        echo "$files" | sed 's/^/    /'
        return 1
    else:
        echo -e "${GREEN}[✓] SAFE - No malicious files found${NC}"
        return 0
    fi
}

# 计数器
VULNERABLE_COUNT=0
SAFE_COUNT=0

echo ""
echo "======================================================================="
echo "VULNERABILITY CHECKS"
echo "======================================================================="

# 检查1: outputs目录
if ! check_file "/usr/src/app/outputs/PWNED_outputs.py" \
    "PWNED file in outputs directory" \
    "HIGH - Can persist malicious code"; then
    ((VULNERABLE_COUNT++))
else
    ((SAFE_COUNT++))
fi

# 检查2: 应用根目录
if ! check_file "/usr/src/app/PWNED_app_root.py" \
    "PWNED file in app root" \
    "CRITICAL - Can modify application code"; then
    ((VULNERABLE_COUNT++))
else
    ((SAFE_COUNT++))
fi

# 检查3: my-docs目录
if ! check_file "/usr/src/app/my-docs/PWNED_mydocs.py" \
    "PWNED file in my-docs" \
    "HIGH - Can access user documents"; then
    ((VULNERABLE_COUNT++))
else
    ((SAFE_COUNT++))
fi

# 检查4: .env备份文件
if ! check_file "/usr/src/app/.env.PWNED_BACKUP" \
    ".env backup file" \
    "CRITICAL - Information disclosure (API keys)"; then
    ((VULNERABLE_COUNT++))
else
    ((SAFE_COUNT++))
fi

# 检查5: backend目录
if ! check_file "/usr/src/app/backend/server/PWNED_server.py" \
    "PWNED file in backend/server" \
    "CRITICAL - Can modify server code"; then
    ((VULNERABLE_COUNT++))
else
    ((SAFE_COUNT++))
fi

# 检查6: 相对路径遍历
if ! check_file "/usr/src/app/PWNED_relative.py" \
    "PWNED file via relative traversal" \
    "HIGH - Bypassed path restrictions"; then
    ((VULNERABLE_COUNT++))
else
    ((SAFE_COUNT++))
fi

# 检查7: 扫描所有PWNED文件
echo -e "\n${BLUE}[*] Scanning for any PWNED files in container...${NC}"
ALL_PWNED=$(docker exec $CONTAINER_ID find /usr/src/app -name "*PWNED*" 2>/dev/null || true)

if [ -n "$ALL_PWNED" ]; then
    echo -e "${RED}[✗] Found PWNED files:${NC}"
    echo "$ALL_PWNED" | sed 's/^/    /'
    ADDITIONAL_FILES=$(echo "$ALL_PWNED" | wc -l)
    echo "    Total: $ADDITIONAL_FILES files"
else
    echo -e "${GREEN}[✓] No PWNED files found in container${NC}"
fi

# 检查主机侧挂载目录
echo ""
echo "======================================================================="
echo "HOST-SIDE MOUNTED DIRECTORIES"
echo "======================================================================="

echo -e "\n${BLUE}[*] Checking host-side ./outputs directory...${NC}"
if [ -d "./outputs" ]; then
    OUTPUTS_PWNED=$(find ./outputs -name "*PWNED*" 2>/dev/null || true)
    if [ -n "$OUTPUTS_PWNED" ]; then
        echo -e "${RED}[✗] CRITICAL: Malicious files persisted on host!${NC}"
        echo "$OUTPUTS_PWNED" | sed 's/^/    /'
        ((VULNERABLE_COUNT++))
    else
        echo -e "${GREEN}[✓] Clean - No malicious files${NC}"
        ((SAFE_COUNT++))
    fi
else
    echo -e "${YELLOW}[!] Directory not found${NC}"
fi

echo -e "\n${BLUE}[*] Checking host-side ./my-docs directory...${NC}"
if [ -d "./my-docs" ]; then
    DOCS_PWNED=$(find ./my-docs -name "*PWNED*" 2>/dev/null || true)
    if [ -n "$DOCS_PWNED" ]; then
        echo -e "${RED}[✗] CRITICAL: Malicious files persisted on host!${NC}"
        echo "$DOCS_PWNED" | sed 's/^/    /'
        ((VULNERABLE_COUNT++))
    else
        echo -e "${GREEN}[✓] Clean - No malicious files${NC}"
        ((SAFE_COUNT++))
    fi
else
    echo -e "${YELLOW}[!] Directory not found${NC}"
fi

# 最终结果
echo ""
echo "======================================================================="
echo "FINAL RESULTS"
echo "======================================================================="

TOTAL_CHECKS=$((VULNERABLE_COUNT + SAFE_COUNT))

echo -e "\nTotal checks: $TOTAL_CHECKS"
echo -e "${GREEN}Safe: $SAFE_COUNT${NC}"
echo -e "${RED}Vulnerable: $VULNERABLE_COUNT${NC}"

if [ $VULNERABLE_COUNT -gt 0 ]; then
    echo ""
    echo -e "${RED}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║                  VULNERABILITY CONFIRMED!                      ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}[!] The Zip Slip vulnerability exists in gpt-researcher${NC}"
    echo -e "${YELLOW}[!] Malicious DOCX files can write to arbitrary locations${NC}"
    echo ""
    echo -e "${BLUE}IMPACT:${NC}"
    echo "  • Arbitrary file write in container"
    echo "  • Potential code execution"
    echo "  • Information disclosure (API keys in .env)"
    echo "  • Persistence across container restarts (if in mounted volumes)"
    echo ""
    echo -e "${BLUE}REMEDIATION:${NC}"
    echo "  1. Implement path sanitization in document extraction"
    echo "  2. Use safe extraction methods (check for '../' in paths)"
    echo "  3. Extract to isolated temporary directory"
    echo "  4. Validate file paths before writing"
    echo "  5. See: proposed_fix_server_utils.py"
    echo ""
    EXIT_CODE=1
else
    echo ""
    echo -e "${GREEN}╔════════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║                    SYSTEM IS SECURE                            ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${GREEN}[✓] No Zip Slip vulnerability detected${NC}"
    echo -e "${GREEN}[✓] Document extraction properly sanitized${NC}"
    echo ""
    EXIT_CODE=0
fi

echo "======================================================================="

exit $EXIT_CODE
